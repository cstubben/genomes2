enaSRA <-function(tax, limit = 500)
{
   if( length(tax) > 1){tax <- tax[1]; print("Warning: only the first id will be used")}
   #check if number passed as character, eg  2  = "2"
   if(!is.na(suppressWarnings(as.numeric( tax)))){ tax <-as.numeric(tax) }
   if(!is.numeric(tax)){ tax <- tax2id(tax)  }


# feb 5 change sra_sample to sample...
# cannot parse results...Extra content at the end of the document

   url1 <- "http://www.ebi.ac.uk/ena/data/view/Taxon:"
  url2 <- paste( "&portal=sample&limit=", limit, "&subtree=true&display=xml", sep="")

#url1 <- "http://www.ebi.ac.uk/ena/data/warehouse/search?query=tax_tree("
#url2 <- ")&domain=sample&result=sample&display=xml"

   url  <- paste(url1, tax, url2, sep="")

  x <- readLines(url, encoding="latin1")
  x <-c("<ENA>", x, "</ENA>")

#   x <- readLines(url)
     connecterror <- grepl("ERROR", x)
     if (any(connecterror)) {
        print(paste("Error connecting to NCBI ", x[connecterror]))
     }
   ## added Feb 5, 2013 - urls are empty pages
   if(length(x)==0){
      print("No results found")
   }else if(length(x) == 2 ){
     # IF no match to id using display =xml , then 2 lines returned with request in root tag
      print("Result not found.") 
   } else{
    doc <- xmlParse(x)
    ###   CREATE LOOP
    z <- getNodeSet(doc, "//SAMPLE")
    n <- length(z)
    sra <- vector("list", n)
    for (i in 1:n) {
        z2 <- xmlDoc(z[[i]])
        taxid <- as.numeric( xvalue(z2, "//TAXON_ID") )
        name <- xvalue(z2, "//SCIENTIFIC_NAME")
        title <- xvalue(z2, "//TITLE")
        title <- gsub("([^;]*).*", "\\1", title)   # multiple titles ?
        # use title if scientific name is missing or keep separate?
        if(is.na(name)) name <- title
        sample  <- xattr(z2, "//SAMPLE", "accession")
        alias   <- xattr(z2, "//SAMPLE", "alias")
        alias <- gsub(name, "", alias)  # alias is often duplicate of name
        center <- xattr(z2, "//SAMPLE", "center_name")
        center <- gsub("([^,]*).*", "\\1",center)    # multiple centers?
        study      <- xtags(z2, "//XREF_LINK", "DB", "ID", "ENA-STUDY")
        submission <- xtags(z2, "//XREF_LINK", "DB", "ID", "ENA-SUBMISSION")
        experiment <- xtags(z2, "//XREF_LINK", "DB", "ID", "ENA-EXPERIMENT")
        #run       <- xtags(z2, "//XREF_LINK", "DB", "ID", "ENA-RUN")
        bases  <- as.numeric( xtags(z2, "//SAMPLE_ATTRIBUTE", "TAG", "VALUE", "ENA-BASE-COUNT") )
        reads  <- as.numeric( xtags(z2, "//SAMPLE_ATTRIBUTE", "TAG", "VALUE", "ENA-SPOT-COUNT") )
        sra[[i]] <- data.frame(taxid, name, alias, sample, submission, study, experiment, center, bases, reads, stringsAsFactors = FALSE)
        free(z2)
    }
    sra <- do.call("rbind", sra)
    sra <- sra[order(sra$name, sra$alias),]
    rownames(sra) <- NULL
    sra
  } 
}



